<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaithCafe - Admin</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">FaithCafe - Admin</div>
            <nav>
                <ul>
                    <li><a href="home.html">Home</a></li>
                    <li><a href="adminmenu.html">Menu</a></li>
                    <li><a href="manage_users.html">Manage Users</a></li>
                </ul>
            </nav>
            <div id="auth-links" class="auth-links"></div>
            <button id="theme-toggle" class="theme-toggle">ðŸŒ™</button>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title">Edit Menu</h1>

            <section class="menu-category">
                <h2>Edit Menu</h2>
                <div id="admin-menu-list"></div>
                <hr />
                <h3>Add / Edit Item</h3>
                <div style="max-width:600px;">
                    <input id="menu-name" placeholder="Name" />
                    <input id="menu-price" placeholder="Price" type="number" step="0.01" />
                    <input id="menu-image" placeholder="Image URL" />
                    <button class="btn" onclick="saveMenuItem()">Save Item</button>
                </div>
            </section>

            <!-- Manage Users moved to a dedicated page -->
        </div>
    </main>

    <footer>
        <div class="container footer-content">
            <p>&copy; 2025 FaithCafe. All rights reserved.</p>
        </div>
    </footer>

    <script src="../static/js/script.js"></script>
    <script>
        // Protect page: only admin
        document.addEventListener('DOMContentLoaded', function() {
            if (!isRole('admin')) {
                showNotification('Access denied. Admin only page.');
                setTimeout(() => window.location.href = '../index.html', 1200);
                return;
            }

            renderAdminMenu();
            renderAdminUsers();

            // If a query param ?edit=<index> is present, open that item for editing
            try {
                const params = new URLSearchParams(window.location.search);
                // support ?edit=<index> (legacy) or ?name=<item name>
                const editIdx = params.has('edit') ? parseInt(params.get('edit'), 10) : -1;
                if (!isNaN(editIdx) && editIdx >= 0) {
                    setTimeout(() => editMenuItem(editIdx), 50);
                } else if (params.has('name')) {
                    const name = params.get('name');
                    const menu = getMenuItems();
                    const idx = menu.findIndex(m => m.name === name);
                    if (idx !== -1) {
                        setTimeout(() => editMenuItem(idx), 50);
                    } else {
                        // Item not in storage; prefill the name field so admin can add/edit
                        setTimeout(() => {
                            const nameField = document.getElementById('menu-name');
                            if (nameField) {
                                nameField.value = name;
                                _editingIndex = -1; // create as new unless admin selects existing
                            }
                        }, 50);
                    }
                }
            } catch (e) {
                console.error('Failed to parse edit param', e);
            }
        });

        function renderAdminMenu() {
            const menu = getMenuItems();
            const container = document.getElementById('admin-menu-list');
            container.innerHTML = '';
            if (!menu || menu.length === 0) {
                container.innerHTML = '<p>No menu items yet.</p>';
                return;
            }

            menu.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'menu-item';
                el.style.padding = '10px';
                el.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>${item.name}</strong>
                            <div>â‚±${item.price.toFixed(2)}</div>
                        </div>
                        <div>
                            <button class="btn-secondary" onclick="editMenuItem(${idx})">Edit</button>
                            <button class="btn" onclick="deleteMenuItem(${idx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function renderAdminUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const container = document.getElementById('admin-users-list');
            container.innerHTML = '';
            if (users.length === 0) {
                container.innerHTML = '<p>No users yet.</p>';
                return;
            }
            users.forEach((u, idx) => {
                const el = document.createElement('div');
                el.className = 'order-history-card';
                el.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div><strong>${u.username}</strong> (${u.email})</div>
                            <div>Role: ${u.role || 'customer'}</div>
                        </div>
                        <div>
                            <button class="btn" onclick="deleteUser(${idx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // Menu item CRUD helpers (use getMenuItems/saveMenuItems from script.js core additions)
        let _editingIndex = -1;
        function saveMenuItem() {
            const name = document.getElementById('menu-name').value.trim();
            const price = parseFloat(document.getElementById('menu-price').value || '0');
            const image = document.getElementById('menu-image').value.trim();
            if (!name || isNaN(price)) return showNotification('Provide name and price', 'error');

            const menu = getMenuItems();
            const item = { name, price, image };
            if (_editingIndex >= 0) {
                menu[_editingIndex] = item;
                _editingIndex = -1;
            } else {
                menu.push(item);
            }
            saveMenuItems(menu);
            document.getElementById('menu-name').value = '';
            document.getElementById('menu-price').value = '';
            document.getElementById('menu-image').value = '';
            renderAdminMenu();
            showNotification('Menu saved', 'success');
        }

        function editMenuItem(idx) {
            const menu = getMenuItems();
            const item = menu[idx];
            if (!item) return;
            _editingIndex = idx;
            document.getElementById('menu-name').value = item.name;
            document.getElementById('menu-price').value = item.price;
            document.getElementById('menu-image').value = item.image || '';
        }

        function deleteMenuItem(idx) {
            if (!confirm('Delete this menu item?')) return;
            const menu = getMenuItems();
            menu.splice(idx,1);
            saveMenuItems(menu);
            renderAdminMenu();
            showNotification('Menu item deleted', 'success');
        }

        // Role toggling removed per request

        function deleteUser(idx) {
            if (!confirm('Delete this user?')) return;
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.splice(idx,1);
            localStorage.setItem('users', JSON.stringify(users));
            renderAdminUsers();
            showNotification('User deleted', 'success');
        }
    </script>
</body>
</html>
